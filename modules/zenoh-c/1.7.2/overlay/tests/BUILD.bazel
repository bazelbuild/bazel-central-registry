load("@rules_cc//cc:defs.bzl", "cc_test")

TEST_SRCS = glob(
    ["*.c"],
    exclude = [
        "z_api_alignment_test.c",
        "z_api_shm_test.c",
        "z_build_static.c",
    ],
)

TEST_NAMES = [src.replace(".c", "") for src in TEST_SRCS]

[cc_test(
    name = test_name,
    size = "small",
    srcs = [
        test_name + ".c",
        "z_int_helpers.h",
    ],
    linkopts = select({
        "@platforms//os:linux": [
            "-lrt",
            "-lpthread",
        ],
        "//conditions:default": [],
    }),
    deps = ["@zenohc"],
    tags = ["exclusive"] if test_name in [
        "z_int_pub_cache_query_sub_test",
        "z_int_pub_sub_test",
        "z_int_queryable_test",
    ] else [],
) for test_name in TEST_NAMES]
