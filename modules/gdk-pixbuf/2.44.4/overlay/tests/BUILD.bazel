load("@rules_cc//cc:cc_test.bzl", "cc_test")

TESTS = [
    "animation",
    "pixbuf-area-updated",
    "pixbuf-composite",
    "pixbuf-construction",
    "pixbuf-dpi",
    "pixbuf-fail",
    "pixbuf-gif",
    "pixbuf-gif-circular-table",
    "pixbuf-icon-serialize",
    "pixbuf-icc",
    "pixbuf-jpeg",
    "pixbuf-randomly-modified",
    "pixbuf-readonly-to-mutable",
    "pixbuf-reftest",
    "pixbuf-save",
    "pixbuf-scale",
    "pixbuf-scale-two-step",
    "pixbuf-short-gif-write",
    "pixbuf-stream",
    "pixbuf-threads",
]

TEST_DATA = glob([
    "*.ani",
    "*.bmp",
    "*.gif",
    "*.jpeg",
    "*.jpg",
    "*.pixdata",
    "*.png",
    "*.tiff",
    "test-images/**",
])

[
    cc_test(
        name = test_name,
        srcs = [
            test_name + ".c",
            "test-common.c",
            "test-common.h",
        ],
        data = TEST_DATA,
        defines = ["HAVE_CONFIG_H"],
        linkstatic = True,
        deps = [
            "//:config",
            "//gdk-pixbuf",
        ],
        env = {
            "G_TEST_SRCDIR": "tests",
            "G_TEST_BUILDDIR": ".",
        },
    )
    for test_name in TESTS
]

cc_test(
    name = "pixbuf-lowmem",
    srcs = [
        "pixbuf-lowmem.c",
    ],
    data = TEST_DATA,
    defines = ["HAVE_CONFIG_H"],
    linkstatic = True,
    deps = [
        "//:config",
        "//gdk-pixbuf",
    ],
    args = [
        "16777216",
        "tests/test-image.png",
    ],
)

cc_test(
    name = "pixbuf-save-ref",
    srcs = ["pixbuf-save-ref.c"],
    data = TEST_DATA,
    defines = ["HAVE_CONFIG_H"],
    linkstatic = True,
    deps = [
        "//:config",
        "//gdk-pixbuf",
    ],
    args = ["tests/test-image.png"],
)
