matrix:
  platform:
  - ubuntu2004
  - macos
tasks:
  verify_targets:
    name: Verify build targets
    platform: ${{ platform }}
    environment:
      ERLANG_VERSION: "24.3"
    shell_commands:
    - curl -O https://raw.githubusercontent.com/kerl/kerl/master/kerl
    - chmod a+x kerl
    - ./kerl update releases
    - ./kerl build ${ERLANG_VERSION}
    - ./kerl install ${ERLANG_VERSION} ~/kerl/${ERLANG_VERSION}
    - |
        ERLANG_HOME="$(realpath ~/kerl/${ERLANG_VERSION})"
        cat << EOF >> user.bazelrc
          build --@rules_erlang//:erlang_version=${ERLANG_VERSION}
          build --@rules_erlang//:erlang_home=${ERLANG_HOME}
        EOF
    build_flags:
    - --incompatible_strict_action_env
    - --extra_toolchains=@rules_erlang//:erlang_toolchain_external
    build_targets:
    - '@rules_erlang//...'
bcr_test_module:
  module_path: "test"
  tasks:
    run_test_module_ubuntu:
      name: "Run test module (Ubuntu)"
      platform: ubuntu2004
      environment:
        ERLANG_VERSION: "24.3"
      shell_commands:
      - curl -O https://raw.githubusercontent.com/kerl/kerl/master/kerl
      - chmod a+x kerl
      - ./kerl update releases
      - ./kerl build ${ERLANG_VERSION}
      - ./kerl install ${ERLANG_VERSION} ~/kerl/${ERLANG_VERSION}
      build_flags:
      - --@rules_erlang//:erlang_version=24.3
      - --@rules_erlang//:erlang_home=/var/lib/buildkite-agent/kerl/24.3
      - --extra_toolchains=@rules_erlang//:erlang_toolchain_external
      - --incompatible_strict_action_env
      - --config=local
      build_targets:
      - "//..."
    run_test_module_mac:
      name: "Run test module (macOS)"
      platform: macos
      environment:
        ERLANG_VERSION: "24.3"
      shell_commands:
      - curl -O https://raw.githubusercontent.com/kerl/kerl/master/kerl
      - chmod a+x kerl
      - ./kerl update releases
      - ./kerl build ${ERLANG_VERSION}
      - ./kerl install ${ERLANG_VERSION} ~/kerl/${ERLANG_VERSION}
      build_flags:
      - --@rules_erlang//:erlang_version=24.3
      - --@rules_erlang//:erlang_home=/Users/buildkite/kerl/24.3
      - --extra_toolchains=@rules_erlang//:erlang_toolchain_external
      - --incompatible_strict_action_env
      - --config=local
      build_targets:
      - "//..."
