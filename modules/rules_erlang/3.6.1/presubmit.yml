matrix:
  platform:
  - ubuntu2004
  - macos
tasks:
  verify_targets:
    name: Verify build targets
    platform: ${{ platform }}
    environment:
      ERLANG_VERSION: "25.0"
    shell_commands:
    - curl -O https://raw.githubusercontent.com/kerl/kerl/master/kerl
    - chmod a+x kerl
    - ./kerl update releases
    - ./kerl build ${ERLANG_VERSION}
    - ./kerl install ${ERLANG_VERSION} ~/kerl/${ERLANG_VERSION}
    - ERLANG_HOME="$(realpath ~/kerl/${ERLANG_VERSION})"
    - |
        cat << EOF >> $(ls MODULE*)
        erlang_config_extension = use_extension(
            "@rules_erlang//bzlmod:extensions.bzl",
            "erlang_config",
        )

        erlang_config_extension.external_erlang_from_path(
            name = "static",
            version = "${ERLANG_VERSION}",
            erlang_home = "${ERLANG_HOME}",
        )

        use_repo(
            erlang_config_extension,
            "erlang_config",
        )
        EOF
    build_flags:
    - --incompatible_strict_action_env
    - --extra_toolchains=@erlang_config//static:toolchain
    build_targets:
    - '@rules_erlang//...'
