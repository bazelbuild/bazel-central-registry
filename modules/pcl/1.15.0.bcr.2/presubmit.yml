build_and_test_flags: &build_and_test_flags
  - --cxxopt=-std=c++17
  - --process_headers_in_dependencies
  - --@pcl//:pcl_silence_malloc_warning=True
windows_build_and_test_flags: &windows_build_and_test_flags
  - --cxxopt=/std:c++17
  - --process_headers_in_dependencies
  - --@pcl//:pcl_silence_malloc_warning=True
  - --features=-layering_check  # Something goes wrong in Boost.Thread on Windows

matrix: &matrix
  platform:
    - debian10
    - debian11
    - macos
    - macos_arm64
    - ubuntu2004
    - ubuntu2204
  bazel: [7.x, 8.x, rolling]

tasks:
  verify_targets:
    name: Verify build targets
    platform: ${{ platform }}
    bazel: ${{ bazel }}
    build_flags: *build_and_test_flags
    test_flags: *build_and_test_flags
    build_targets:
      - '@pcl//...'
      - '-@pcl//test/...'
  verify_targets_windows:
    name: Verify Windows build targets
    platform: windows
    bazel: ${{ bazel }}
    build_flags: *windows_build_and_test_flags
    test_flags: *windows_build_and_test_flags
    build_targets:
      - '@pcl//...'
      - '-@pcl//test/...'

bcr_test_module:
  module_path: test
  matrix: *matrix
  tasks:
    run_test_module:
      name: Run test module
      platform: ${{ platform }}
      bazel: ${{ bazel }}
      build_flags: *build_and_test_flags
      test_flags: *build_and_test_flags
      build_targets: [//...]
      test_targets: [//...]
    run_test_module_windows:
      name: Run Windows test module
      platform: windows
      bazel: ${{ bazel }}
      build_flags: *windows_build_and_test_flags
      test_flags: *windows_build_and_test_flags
      build_targets: [//...]
      test_targets: [//...]
