# BUILD file for QuickJS tests.

package(default_visibility = ["//visibility:public"])

# Build the bjson.so shared library needed for the bjson test.
cc_binary(
    name = "bjson.so",
    srcs = ["bjson.c"],
    defines = ["JS_SHARED_LIBRARY"],
    linkshared = True,
    deps = ["//:quickjs"],  # Depends on the core qjs library
)

# Create a shell test for each javascript test file.
# The 'srcs' attribute points to the test runner (the qjs interpreter).
# The 'args' attribute provides the arguments to the runner (the js file).
# The 'data' attribute makes runtime files available to the test.

sh_test(
    name = "test_closure",
    srcs = ["//:qjs"],
    args = ["$(location test_closure.js)"],
    data = ["test_closure.js"],
)

sh_test(
    name = "test_language",
    srcs = ["//:qjs"],
    args = ["$(location test_language.js)"],
    data = ["test_language.js"],
)

sh_test(
    name = "test_builtin",
    srcs = ["//:qjs"],
    args = [
        "--std",
        "$(location test_builtin.js)",
    ],
    data = ["test_builtin.js"],
)

sh_test(
    name = "test_bigint",
    srcs = ["//:qjs"],
    args = ["$(location test_bigint.js)"],
    data = ["test_bigint.js"],
)

sh_test(
    name = "test_bjson",
    srcs = ["//:qjs"],
    args = ["$(location test_bjson.js)"],
    data = [
        "test_bjson.js",
        ":bjson.so",
    ],
)

sh_test(
    name = "test_std",
    srcs = ["//:qjs"],
    args = ["$(location test_std.js)"],
    data = ["test_std.js"],
)

# A test suite to run all defined tests together.
test_suite(
    name = "all_tests",
    tests = [
        ":test_bigint",
        ":test_bjson",
        ":test_builtin",
        ":test_closure",
        ":test_language",
        ":test_std",
    ],
)
